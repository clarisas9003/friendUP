<!DOCType html>
<html lang = 'en'> 
  <head>
    <title>friendUP</title>
    <link href="loginPage.css" rel="stylesheet" type="text/css" />
   </head>
  <body>
    <img src= catpic.jfif width="300" height="400" alt="cat" class="center">

<p> 
<!--<label type = "text"> Login</label>-->
<p style="font-size:30px">friendUp!</p> 
</p>

    <form>
    <label style="font-size:20px">Username:</label><br>
  <input type="text" id="fname" name="fname"><br>
  <br> <label style="font-size:20px">Password:</label><br>
  <input type="text" id="password" name="password"><br><br>
  <button type="button" id="loginBtn">Log In</button> 

</form>

<form>
  <br> <label>Login using your Umich Profile</label><br><br>
  <label> Don't have an account?</label><br> <br>
  <label>Register yours today!</label><br><br>
<button type="button" id="regBtn">Register Your Account</button>

</form>
</body>

 <!-- List of Landscapes loaded from Firebase -->
        
 <div id="landscape-jump"class="table-responsive">
  <h2 class=" border-top" >Landscape Information</h2>
  <table class="table table-striped table-sm table-hover">
  <thead>
      <tr>
      <th scope="col">User#</th>
      <th scope="col">Carbon (MMTCDE)</th>
      <th scope="col">Savings</th>
      <th scope="col">Storm Water (Liters)</th>
      <th scope="col">Item Category</th>
      </tr>
  </thead>
  <tbody id="landscape-table">

  </tbody>
  </table>
</div>
</main>
</div>
</div>
</div>

<!-- I believe we can move this to a file, once it is on the github web server!-->
<script type="module">

// Import the functions you need from the SDKs you need
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.4/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.6.4/firebase-analytics.js";
import { getDatabase, ref, set, get, child, onValue } from "https://www.gstatic.com/firebasejs/9.6.4/firebase-database.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, sendPasswordResetEmail, GoogleAuthProvider, signInWithPopup, signOut, updatePassword } from "https://www.gstatic.com/firebasejs/9.6.4/firebase-auth.js";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
apiKey: "AIzaSyDmcm80-JNkoVjAi-aQTYPOXEsq1WueH6o",
authDomain: "landscape-info.firebaseapp.com",
databaseURL: "https://landscape-info-default-rtdb.firebaseio.com",
projectId: "landscape-info",
storageBucket: "landscape-info.appspot.com",
messagingSenderId: "453148430492",
appId: "1:453148430492:web:9503f2b6c5edcc9c119d59",
measurementId: "G-3N0RQ6FY8V"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const database = getDatabase();
const provider = new GoogleAuthProvider();

let displayName = "";

function writeUserData(userId, name, email) {
const db = getDatabase();
userId = "TestId";
name = "TestName";
email = "TestEmail";
member = "TestType";
set(ref(db, 'Account/' + email), {
email: email,
Permissions: member
});
}

function readUserData(tableName){

//Get the table you want to use and set that to table
let table = tableName;

const db = getDatabase();
const dbRef = ref(db, table);
let list = [];
onValue(dbRef, (snapshot) => {
snapshot.forEach((childSnapshot) => {
  const childKey = childSnapshot.key;
  const childData = childSnapshot.val();
  list.push(childData);
  pushTable(childData, childKey);
});
}, {
onlyOnce: true
});

setLandscapes(list);

return list;
}

function getData(tableName){

const db = getDatabase();
const dbRef = ref(db, tableName);
let list = [];
onValue(dbRef, (snapshot) => {
snapshot.forEach((childSnapshot) => {
const childKey = childSnapshot.key;
const childData = childSnapshot.val();
list.push(childData);
});
}, {
onlyOnce: true
});
return list;
}

function pushTable(child, counter){
let table = d3.select("#landscape-table");
let row = table.append("tr");
let carbon = child["Carbon"];
let savings = child["Savings"];
let stormwater = child["Stormwater"];
let category = child["Item Category"];

row.attr("id", "row-" + counter)
.append("td")
.html("#" + (Number(counter) + 1));
row.append("td")
.html(carbon);
row.append("td")
.html("$" + savings);
row.append("td")
.html(stormwater + "L");
row.append("td")
.html(category);

//totalCount(carbon, savings, stormwater, cateogry);
}

function authentication(email, password){
const auth = getAuth();
if (document.getElementById("floatingInput").value=='') {
email = document.querySelector("#emailInput").value;
}
if (document.getElementById("floatingPassword").value==''){
password = document.querySelector("#passwordInput").value;
}

signInWithEmailAndPassword(auth, email, password)
.then((userCredential) => {
  // Signed in 
  const user = userCredential.user;
  console.log("Success (authentication)");
  if (user !== null) {
          user.providerData.forEach((profile) => {
              if (profile.displayName !== null){
                  document.querySelector("#user-click").innerHTML = `<span data-feather="file"></span>
              <i class="fa fa-fw fa-user"></i> ${profile.displayName}` ;
                  console.log("Success in getting the display name");
              }
              
              return; //Only have the return here to get the first profile
          });

         
      }

  resetFields(); //Function from index.js
  document.getElementById("signInOut").innerHTML = "Sign Out";
  document.getElementById("signInOut").removeAttribute("data-bs-toggle");
  document.getElementById("signInOut").removeAttribute("data-bs-target");  
  document.getElementById( "signInOut" ).onclick = logOut;
})
.catch((error) => {
  const errorCode = error.code;
  const errorMessage = error.message;
  console.log(errorCode, "(authentication)");
  console.log(errorMessage, "(authentication)");
  openAlert(errorMessage, "Could not authenticate");
  resetFields();
});

}

function googleLogin() {

const auth = getAuth();
signInWithPopup(auth, provider)
.then((result) => {
// This gives you a Google Access Token. You can use it to access the Google API.
const credential = GoogleAuthProvider.credentialFromResult(result);
const token = credential.accessToken;
// The signed-in user info.
const user = result.user;
document.getElementById("signInOut").innerHTML = "Sign Out";
document.getElementById("signInOut").removeAttribute("data-bs-toggle");
document.getElementById("signInOut").removeAttribute("data-bs-target");  
document.getElementById( "signInOut" ).onclick = logOut;
//setName(auth, user);
let name = auth.currentUser.email;
let re = new RegExp("[^.?=@]*"); 
name = re.exec(name)[0];
document.querySelector("#user-click").innerHTML = `<span data-feather="file"></span>
              <i class="fa fa-fw fa-user"></i> ${name}`;
// ...
}).catch((error) => {
// Handle Errors here.
const errorCode = error.code;
const errorMessage = error.message;
// The email of the user's account used.
const email = error.email;
// The AuthCredential type that was used.
const credential = GoogleAuthProvider.credentialFromError(error);
openAlert(errorMessage, "Could not Authenticate")
// ...
});

}

function createAccount(){
const auth = getAuth();
displayName = document.querySelector("#displayName").value;
let email = document.querySelector("#floatingInput").value;
let password = document.querySelector("#floatingPassword").value;  
createUserWithEmailAndPassword(auth, email, password)
.then((userCredential) => {
  // Signed in 
  const user = userCredential.user;
  console.log("Success (create Account)");
  openAlert("", "Account was successfully created");
  setName(auth, user);
  authentication(email, password);
  // ...
})
.catch((error) => {
  const errorCode = error.code;
  const errorMessage = error.message;
  console.log(errorCode, "(create Account)");
  console.log(errorMessage, "(create Account)");
  openAlert(errorMessage, "Account could not be created");
  // ..
});
}

function setName(auth, user){

updateProfile(auth.currentUser, {
  displayName: displayName
  }).then(() => {

      if (user !== null) {
              document.querySelector("#user-click").innerHTML = `<span data-feather="file"></span>
              <i class="fa fa-fw fa-user"></i> ${displayName}`;
              console.log("Success in setName");            
      }
      resetFields(); //Function from index.js
  }).catch((error) => {
  // An error occurred
  // ...
      openAlert(error, "Could not set display name");
      console.log(error);
      resetFields();
  });
}

function forgetPassword(){

const auth = getAuth();
let emailAdd = document.querySelector("#emailSend").value;
sendPasswordResetEmail(auth, emailAdd)
.then(() => {
// Password reset email sent!
// ..
openAlert("", "Email was sent successfully");
})
.catch((error) => {
const errorCode = error.code;
const errorMessage = error.message;
openAlert(errorMessage, "Password could not be reset");
// ..
});
}

function logOut() {
const auth = getAuth();
signOut(auth).then(() => {
// Sign-out successful.
let name = "User";
document.querySelector("#user-click").innerHTML = `<span data-feather="file"></span>
              <i class="fa fa-fw fa-user"></i> ${name}`;
openAlert("", "Sign Out Was Successful");

})

.catch((error) => {
  console.log("Error in logOut:", error);
// An error happened.
openAlert(error, "Could not sign out");
});

document.getElementById("signInOut").innerHTML = "Sign In";
document.getElementById("signInOut").onclick = null;
document.getElementById("signInOut").setAttribute("data-bs-toggle", "modal");
document.getElementById("signInOut").setAttribute("data-bs-target", "#login-modal");

}

function userChange() {
const auth = getAuth();
const user = auth.currentUser;
displayName = document.querySelector("#newDisplay").value;

if(displayName != "") {
  setName(auth, user)
}
}

function passChange() {
const auth = getAuth();
const user = auth.currentUser;
let newPassword = document.querySelector("#changePassword").value;

if(newPassword != "") {
  updatePassword(user, newPassword).then(() => {
  // Update successful.
  openAlert("", "Password change was successful");
  }).catch((error) => {
  // An error ocurred
  // ...
  openAlert("", "Password change failed");
  });
}
}

//document.querySelector("#signInOut").onclick = readUserData;
document.querySelector("#login-button").onclick = authentication; 
document.querySelector("#sign-up-button").onclick = createAccount;
document.querySelector("#send-button").onclick = forgetPassword;
document.querySelector("#google-button").onclick = googleLogin;
document.querySelector("#google-sign-up").onclick = googleLogin;
document.querySelector("#settings-button").onclick = userChange;
document.querySelector("#change-button").onclick = passChange;
readUserData("performance");
createBarGraphExample("#example-graph-1");
createHistogramExample("#example-graph-2");
createLineGraphExample("#example-graph-3");

setData(getData("account"), "account");
setData(getData("item totals"), "item totals");
setData(getData("landscape totals"), "landscape totals");
setData(getData("user activity"), "user activity");
setData(getData("user totals"), "user totals");

